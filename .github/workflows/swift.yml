name: Swift

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  swift:
    name: Lint
    runs-on: macos-11
    steps:
    - name: Repository checkout
      uses: actions/checkout@v2
    - name: Lint
      run: swiftlint
  build:
    name: Build and Archive
    runs-on: macos-11
    steps:
    - name: Repository checkout
      uses: actions/checkout@v2
    - name: Cache SPM modules
      uses: actions/cache@v2
      env:
        cache-name: cache-spm
      with:
        path: SourcePackages
        key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('Pareto Security.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-build-${{ env.cache-name }}-
          ${{ runner.os }}-build-
          ${{ runner.os }}-
    - name: Build
      run: make build archive
    - name: Compress app for storage
      run: zip -r app.zip build/mac/Pareto\ Security.app
    - name: Upload App to Artifacts
      uses: actions/upload-artifact@v2
      with:
        name: app.zip
        path: app.zip
  # test:
  #   name: Unit Tests
  #   runs-on: macos-11
  #   steps:
  #   - name: Repository checkout
  #     uses: actions/checkout@v2
  #   - name: Cache SPM modules
  #     uses: actions/cache@v2
  #     env:
  #       cache-name: cache-spm
  #     with:
  #       path: SourcePackages
  #       key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('Pareto Security.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved') }}
  #       restore-keys: |
  #         ${{ runner.os }}-build-${{ env.cache-name }}-
  #         ${{ runner.os }}-build-
  #         ${{ runner.os }}-
  #   - name: Tests
  #     run: make test
  #   - uses: codecov/codecov-action@v2
  #     with:
  #       fail_ci_if_error: true 
  #       verbose: true