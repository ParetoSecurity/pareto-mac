name: Release

on:
  push:
    tags:
      - "*"

# Prevent duplicate releases
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

# Minimal permissions at workflow level
permissions:
  contents: read

env:
  XCODE_VERSION: "26"

jobs:
  release:
    name: Release Native
    runs-on: macos-latest
    timeout-minutes: 45
    permissions:
      contents: write
      deployments: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get release tag
        id: release
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
          derived-data-key: release

      - name: Setup code signing
        uses: ./.github/actions/setup-signing
        with:
          development-certificate: ${{ secrets.DEVELOPMENT_CERTIFICATE_DATA }}
          development-passphrase: ${{ secrets.DEVELOPMENT_CERTIFICATE_PASSPHRASE }}
          application-certificate: ${{ secrets.APPLICATION_CERTIFICATE_DATA }}
          application-passphrase: ${{ secrets.APPLICATION_CERTIFICATE_PASSPHRASE }}
          release-certificate: ${{ secrets.RELEASE_CERTIFICATE_DATA }}
          release-passphrase: ${{ secrets.RELEASE_CERTIFICATE_PASSPHRASE }}
          keychain-password: ${{ secrets.KEYCHAIN_PASSWORD }}

      - name: Patch version from tag
        env:
          VERSION: ${{ steps.release.outputs.tag }}
        run: |
          sed -E -i '' "s/MARKETING_VERSION = .*;/MARKETING_VERSION = ${VERSION};/g" "Pareto Security.xcodeproj/project.pbxproj"

      - name: Archive for distribution
        run: make archive-release

      - name: Compress app
        run: ditto -c -k --keepParent "Export/Pareto Security.app" ParetoSecurity.app.zip

      - name: Upload app artifact
        uses: actions/upload-artifact@v4
        with:
          name: ParetoSecurity.app
          path: ParetoSecurity.app.zip
          retention-days: 90

      - name: Build DMG
        run: npm install --global create-dmg && make dmg

      - name: Notarize release build
        env:
          NOTARIZATION_PASSWORD: ${{ secrets.NOTARIZATION_PASSWORD }}
          NOTARIZATION_USERNAME: ${{ secrets.NOTARIZATION_USERNAME }}
        run: |
          xcrun notarytool submit ParetoSecurity.dmg \
            --password "$NOTARIZATION_PASSWORD" \
            --apple-id "$NOTARIZATION_USERNAME" \
            --team-id PM784W7B8X \
            --progress \
            --wait

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: ParetoSecurity.dmg
          path: ParetoSecurity.dmg
          retention-days: 90

      - name: Staple DMG
        run: |
          for i in {1..3}; do
            xcrun stapler staple ParetoSecurity.dmg && break || sleep 15
          done

      - name: Release DMG
        uses: softprops/action-gh-release@v2
        with:
          files: ParetoSecurity.dmg

      - name: Prepare app for release
        run: |
          rm -f ParetoSecurity.app.zip
          ditto -c -k --keepParent "Export/Pareto Security.app" ParetoSecurity.app.zip

      - name: Release app
        uses: softprops/action-gh-release@v2
        with:
          files: ParetoSecurity.app.zip

      - name: Generate checks manifest
        run: '"Export/Pareto Security.app/Contents/MacOS/Pareto Security" -export > checks.json'

      - name: Release checks manifest
        uses: softprops/action-gh-release@v2
        with:
          files: checks.json

      - name: Publish build hashes
        run: |
          {
            echo "## Native Release"
            echo '```'
            openssl dgst -md5 "Export/Pareto Security.app/Contents/MacOS/Pareto Security"
            openssl dgst -sha1 "Export/Pareto Security.app/Contents/MacOS/Pareto Security"
            openssl dgst -sha256 "Export/Pareto Security.app/Contents/MacOS/Pareto Security"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Install Sentry CLI
        run: brew install getsentry/tools/sentry-cli

      - name: Upload debug symbols
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: make sentry-debug-upload

      - name: Cleanup keychain
        if: always()
        run: security delete-keychain "$RUNNER_TEMP/app-signing.keychain-db" 2>/dev/null || true

  release-setapp:
    name: Release SetApp
    runs-on: macos-latest
    timeout-minutes: 45
    permissions:
      contents: write
      deployments: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get release tag
        id: release
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
          derived-data-key: release-setapp

      - name: Setup code signing
        uses: ./.github/actions/setup-signing
        with:
          development-certificate: ${{ secrets.DEVELOPMENT_CERTIFICATE_DATA }}
          development-passphrase: ${{ secrets.DEVELOPMENT_CERTIFICATE_PASSPHRASE }}
          application-certificate: ${{ secrets.APPLICATION_CERTIFICATE_DATA }}
          application-passphrase: ${{ secrets.APPLICATION_CERTIFICATE_PASSPHRASE }}
          release-certificate: ${{ secrets.RELEASE_CERTIFICATE_DATA }}
          release-passphrase: ${{ secrets.RELEASE_CERTIFICATE_PASSPHRASE }}
          keychain-password: ${{ secrets.KEYCHAIN_PASSWORD }}

      - name: Install Sentry CLI
        run: brew install getsentry/tools/sentry-cli

      - name: Patch version from tag
        env:
          VERSION: ${{ steps.release.outputs.tag }}
        run: |
          sed -E -i '' "s/MARKETING_VERSION = .*;/MARKETING_VERSION = ${VERSION};/g" "Pareto Security.xcodeproj/project.pbxproj"

      - name: Archive for distribution
        run: make archive-release-setapp

      - name: Upload debug symbols
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        run: make sentry-debug-upload-setapp

      - name: Compress app for notarization
        run: ditto -c -k --keepParent "SetAppExport/Pareto Security.app" ParetoSecurity.app.zip

      - name: Notarize release build
        env:
          NOTARIZATION_PASSWORD: ${{ secrets.NOTARIZATION_PASSWORD }}
          NOTARIZATION_USERNAME: ${{ secrets.NOTARIZATION_USERNAME }}
        run: |
          xcrun notarytool submit ParetoSecurity.app.zip \
            --password "$NOTARIZATION_PASSWORD" \
            --apple-id "$NOTARIZATION_USERNAME" \
            --team-id PM784W7B8X \
            --progress \
            --wait

      - name: Staple app
        run: |
          for i in {1..3}; do
            xcrun stapler staple "SetAppExport/Pareto Security.app" && break || sleep 15
          done

      - name: Compress app for storage
        run: ditto -c -k --keepParent "SetAppExport/Pareto Security.app" ParetoSecuritySetApp.app.zip

      - name: Attach AppIcon for SetApp
        run: make build-release-setapp

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ParetoSecuritySetApp.app
          path: ParetoSecuritySetApp.app.zip
          retention-days: 90

      - name: Publish build hashes
        run: |
          {
            echo "## SetApp Release"
            echo '```'
            openssl dgst -md5 "SetAppExport/Pareto Security.app/Contents/MacOS/Pareto Security SetApp"
            openssl dgst -sha1 "SetAppExport/Pareto Security.app/Contents/MacOS/Pareto Security SetApp"
            openssl dgst -sha256 "SetAppExport/Pareto Security.app/Contents/MacOS/Pareto Security SetApp"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Cleanup keychain
        if: always()
        run: security delete-keychain "$RUNNER_TEMP/app-signing.keychain-db" 2>/dev/null || true
