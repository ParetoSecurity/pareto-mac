name: Test and Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Prevent duplicate workflow runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Restrict permissions at workflow level (principle of least privilege)
permissions:
  contents: read

env:
  XCODE_VERSION: "26"

jobs:
  test:
    name: Test
    runs-on: macos-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
          derived-data-key: test

      - name: Setup code signing
        uses: ./.github/actions/setup-signing
        with:
          development-certificate: ${{ secrets.DEVELOPMENT_CERTIFICATE_DATA }}
          development-passphrase: ${{ secrets.DEVELOPMENT_CERTIFICATE_PASSPHRASE }}
          application-certificate: ${{ secrets.APPLICATION_CERTIFICATE_DATA }}
          application-passphrase: ${{ secrets.APPLICATION_CERTIFICATE_PASSPHRASE }}
          keychain-password: ${{ secrets.KEYCHAIN_PASSWORD }}

      - name: Run tests
        run: make test

      - name: Cleanup keychain
        if: always()
        run: security delete-keychain "$RUNNER_TEMP/app-signing.keychain-db" 2>/dev/null || true

  build:
    name: Build Native
    runs-on: macos-latest
    needs: test
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
          derived-data-key: build

      - name: Setup code signing
        uses: ./.github/actions/setup-signing
        with:
          development-certificate: ${{ secrets.DEVELOPMENT_CERTIFICATE_DATA }}
          development-passphrase: ${{ secrets.DEVELOPMENT_CERTIFICATE_PASSPHRASE }}
          application-certificate: ${{ secrets.APPLICATION_CERTIFICATE_DATA }}
          application-passphrase: ${{ secrets.APPLICATION_CERTIFICATE_PASSPHRASE }}
          keychain-password: ${{ secrets.KEYCHAIN_PASSWORD }}

      - name: Build debug archive
        run: set -o pipefail && make archive-debug 2>&1 | mint run xcbeautify

      - name: Compress app
        run: ditto -c -k --keepParent "Export/Pareto Security.app" ParetoSecurity.app.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ParetoSecurity.app
          path: ParetoSecurity.app.zip
          retention-days: 14

      - name: Publish build hashes
        run: |
          {
            echo "## Debug Build"
            echo '```'
            openssl dgst -md5 "Export/Pareto Security.app/Contents/MacOS/Pareto Security"
            openssl dgst -sha1 "Export/Pareto Security.app/Contents/MacOS/Pareto Security"
            openssl dgst -sha256 "Export/Pareto Security.app/Contents/MacOS/Pareto Security"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Cleanup keychain
        if: always()
        run: security delete-keychain "$RUNNER_TEMP/app-signing.keychain-db" 2>/dev/null || true

  build-setapp:
    name: Build SetApp
    runs-on: macos-latest
    needs: test
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup build environment
        uses: ./.github/actions/setup-build-env
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
          derived-data-key: setapp

      - name: Setup code signing
        uses: ./.github/actions/setup-signing
        with:
          development-certificate: ${{ secrets.DEVELOPMENT_CERTIFICATE_DATA }}
          development-passphrase: ${{ secrets.DEVELOPMENT_CERTIFICATE_PASSPHRASE }}
          application-certificate: ${{ secrets.APPLICATION_CERTIFICATE_DATA }}
          application-passphrase: ${{ secrets.APPLICATION_CERTIFICATE_PASSPHRASE }}
          keychain-password: ${{ secrets.KEYCHAIN_PASSWORD }}

      - name: Build debug archive
        run: set -o pipefail && make archive-debug-setapp 2>&1 | mint run xcbeautify

      - name: Compress app
        run: ditto -c -k --keepParent "SetAppExport/Pareto Security.app" ParetoSecuritySetApp.app.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ParetoSecuritySetApp.app
          path: ParetoSecuritySetApp.app.zip
          retention-days: 14

      - name: Publish build hashes
        run: |
          {
            echo "## SetApp Build"
            echo '```'
            openssl dgst -md5 "SetAppExport/Pareto Security.app/Contents/MacOS/Pareto Security SetApp"
            openssl dgst -sha1 "SetAppExport/Pareto Security.app/Contents/MacOS/Pareto Security SetApp"
            openssl dgst -sha256 "SetAppExport/Pareto Security.app/Contents/MacOS/Pareto Security SetApp"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Cleanup keychain
        if: always()
        run: security delete-keychain "$RUNNER_TEMP/app-signing.keychain-db" 2>/dev/null || true
